name: Python application

on:
  push:
    branches: "main"

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Define la imagen final de Docker Hub/GHCR
    env:
      IMAGE_TAG: ghcr.io/martinsangucho/finalquintoa:latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"

      # --- CONSTRUCCI√ìN E INICIO DE SESI√ìN EN GHCR (OK) ---

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          # Usamos la variable de entorno para el tag
          tags: ${{ env.IMAGE_TAG }}

      # --- PASO 1: TRANSFERIR ARCHIVOS (CORREGIDO) ---

      - name: üìÅ Transferir archivos esenciales por SCP
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          # Corregimos el uso de los par√°metros file/remote_host/etc.
          # Usamos 'source' y 'target' que s√≠ son v√°lidos para la transferencia
          source: "Dockerfile,app.py,requirements.txt,stack.yml"
          target: "/home/${{ secrets.VPS_USER }}/despliegue"

      # --- PASO 2: DESPLIEGUE REMOTO SSH (NUEVO) ---
      # Usamos el script para detener lo viejo y levantar lo nuevo
      - name: üöÄ Desplegar la nueva versi√≥n con Docker Compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          # Comandos a ejecutar en el servidor remoto
          script: |
            echo "Iniciando despliegue en /home/${{ secrets.VPS_USER }}/despliegue"
            cd /home/${{ secrets.VPS_USER }}/despliegue
            
            # Detener contenedores viejos
            docker compose down || true
            
            # Levantar la nueva versi√≥n. El 'up --build' no es necesario 
            # si siempre haces 'docker pull', pero es m√°s seguro si transferiste archivos.
            docker compose up --build -d 
            
            echo "Despliegue finalizado. Verificar en el puerto 8080."